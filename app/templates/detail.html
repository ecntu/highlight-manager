{% extends "base.html" %}

{% block title %}{{ highlight.text[:50] }}... - PHM{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
        <h2>Highlight Details</h2>
        <div style="display: flex; gap: 10px;">
            <button hx-put="/highlights/{{ highlight.id }}/favorite" hx-target="this" hx-swap="outerHTML"
                class="secondary">
                {% if highlight.is_favorite %}★ Favorited{% else %}☆ Favorite{% endif %}
            </button>
            <button hx-delete="/highlights/{{ highlight.id }}" hx-confirm="Archive this highlight?"
                hx-target="closest .card" hx-swap="outerHTML" class="secondary">
                {% if highlight.status.value == 'archived' %}Unarchive{% else %}Archive{% endif %}
            </button>
        </div>
    </div>

    <form hx-patch="/highlights/{{ highlight.id }}" hx-target="this" hx-swap="outerHTML" hx-indicator="#save-indicator">
        <div class="form-group">
            <label>Text</label>
            <textarea name="text" rows="6" required>{{ highlight.text }}</textarea>
        </div>

        <div class="form-group">
            <label>Note</label>
            <textarea name="note" rows="3" placeholder="Why does this matter?">{{ highlight.note or '' }}</textarea>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Tags (comma-separated)</label>
                <input type="text" name="tags"
                    value="{% if highlight.tags %}{% for tag in highlight.tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}"
                    placeholder="tag1, tag2, tag3">
            </div>

            <div class="form-group">
                <label>Source Author</label>
                <input type="text" name="source_author"
                    value="{{ highlight.source.author if highlight.source and highlight.source.author else '' }}"
                    placeholder="Author name">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Source URL (for web sources)</label>
                <input type="text" name="source_url"
                    value="{{ highlight.source.url if highlight.source and highlight.source.url else '' }}"
                    placeholder="https://example.com/article">
            </div>

            <div class="form-group">
                <label>Source Title (for books)</label>
                <input type="text" name="source_title" value="{{ highlight.source.title if highlight.source else '' }}"
                    placeholder="Book or article title">
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button type="submit">
                Save Changes
                <span class="htmx-indicator" id="save-indicator">...</span>
            </button>
            <a href="/highlights"
                style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; font-size: 14px; font-weight: 500;">Cancel</a>
        </div>
    </form>
</div>

<div class="card">
    <h3 style="margin-bottom: 15px; font-size: 16px;">Collections</h3>
    <div style="margin-bottom: 15px;">
        <small style="color: #666;">
            {% if highlight.collections %}
            In {{ highlight.collections|length }} collection(s):
            {% else %}
            Not in any collections yet.
            {% endif %}
        </small>
    </div>
    {% if highlight.collections %}
    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
        {% for collection in highlight.collections %}
        <div
            style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: #e7f3ff; border-radius: 4px; font-size: 14px;">
            <a href="/collections/{{ collection.id }}" style="color: #007bff; text-decoration: none;">
                {{ collection.name }}
            </a>
            <button hx-delete="/collections/{{ collection.id }}/highlights/{{ highlight.id }}" hx-target="closest div"
                hx-swap="outerHTML"
                style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 16px; padding: 0; line-height: 1;">
                ×
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <details style="margin-top: 10px;">
        <summary style="cursor: pointer; color: #007bff; font-size: 14px;">Add to collection</summary>
        <div id="add-to-collection" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
            Loading collections...
        </div>
    </details>
</div>

<div class="card">
    <h3 style="margin-bottom: 15px; font-size: 16px;">Metadata</h3>
    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; font-size: 14px;">
        <strong>Created:</strong>
        <span>{{ highlight.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>

        <strong>Last Updated:</strong>
        <span>{{ highlight.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</span>

        {% if highlight.device %}
        <strong>Captured From:</strong>
        <span>{{ highlight.device.name }}</span>
        {% endif %}

        <strong>Status:</strong>
        <span style="text-transform: capitalize;">{{ highlight.status.value }}</span>
    </div>
</div>

<script>
    // Load available collections when details is opened
    document.querySelector('details').addEventListener('toggle', function (e) {
        if (e.target.open) {
            fetch('/collections')
                .then(r => r.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const collectionsData = [{% for c in highlight.collections %}'{{ c.id }}'{% if not loop.last %}, {% endif %} {% endfor %}];
        const highlightId = '{{ highlight.id }}';

        // Get all collections from the page
        const allCollections = doc.querySelectorAll('#collections-list > div > div');
        const container = document.getElementById('add-to-collection');

        if (allCollections.length === 0) {
            container.innerHTML = '<p style="color: #666; font-size: 14px;">No collections yet. <a href="/collections" style="color: #007bff;">Create one first</a>.</p>';
        } else {
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            allCollections.forEach(col => {
                const link = col.querySelector('a[href^="/collections/"]');
                const collectionId = link.href.split('/').pop();
                const collectionName = link.textContent.trim();
                const isInCollection = collectionsData.includes(collectionId);

                if (!isInCollection) {
                    html += `<button onclick="addToCollection('${collectionId}', '${highlightId}')" 
                                style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; text-align: left; font-size: 14px;">
                                + ${collectionName}
                            </button>`;
                }
            });
            html += '</div>';
            container.innerHTML = html;
        }
    });
    }
});

    function addToCollection(collectionId, highlightId) {
        fetch(`/collections/${collectionId}/highlights/${highlightId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(r => r.json())
            .then(() => window.location.reload());
    }
</script>
{% endblock %}