{% extends "base.html" %}

{% block title %}Highlight{% endblock %}

{% block content %}
<style>
    /* Override base button styles for icon buttons */
    #highlight-view .action-btn:hover {
        background: #f5f5f5;
        color: #1a1a1a;
        transform: none;
        box-shadow: none;
    }

    #highlight-view .action-btn:active {
        transform: none;
    }

    #highlight-view .action-btn.favorite:hover {
        color: #f59e0b;
    }

    /* Pill button hover states */
    .pill-btn:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        transform: none;
        box-shadow: none;
    }

    .pill-btn:active {
        transform: none;
    }
</style>

<div id="highlight-container">
    {% include 'partials/highlight_card.html' %}
</div>

<!-- Collection Picker Modal -->
<div id="collection-modal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;"
    onclick="if(event.target === this) this.style.display='none'">
    <div style="max-width: 420px; width: 90%; background: white; border-radius: 16px; padding: 28px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);"
        onclick="event.stopPropagation()">
        <h3 style="margin-bottom: 20px; font-size: 18px; font-weight: 600; color: #1a1a1a;">Add to Collection</h3>
        <div id="collection-list" style="max-height: 400px; overflow-y: auto;">Loading...</div>
    </div>
</div>

<!-- Tag Add Modal -->
<div id="tag-modal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;"
    onclick="if(event.target === this) this.style.display='none'"></div>

<script>
    function showAddToCollection() {
        const modal = document.getElementById('collection-modal');
        modal.style.display = 'flex';

        fetch('/collections')
            .then(r => r.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const currentCollections = [{% for c in highlight.collections %}'{{ c.id }}'{% if not loop.last %}, {% endif %} {% endfor %}];
    const highlightId = '{{ highlight.id }}';

    const allCollections = doc.querySelectorAll('#collections-list > div > div');
    const container = document.getElementById('collection-list');

    if (allCollections.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; font-size: 14px;">No collections yet. <a href="/collections" style="color: #3b82f6; text-decoration: none; font-weight: 500;">Create one</a>.</p>';
    } else {
        let buttons = '';
        allCollections.forEach(col => {
            const link = col.querySelector('a[href^="/collections/"]');
            const collectionId = link.href.split('/').pop();
            const collectionName = link.textContent.trim();
            const isIn = currentCollections.includes(collectionId);

            buttons += `<button 
                        onclick="addToCollection('${collectionId}', '${highlightId}')" 
                        style="width: 100%; padding: 14px 16px; margin-bottom: 8px; background: ${isIn ? '#f3f4f6' : 'white'}; color: ${isIn ? '#9ca3af' : '#1a1a1a'}; border: 1px solid ${isIn ? '#e5e7eb' : '#e5e5e5'}; border-radius: 10px; cursor: ${isIn ? 'not-allowed' : 'pointer'}; text-align: left; font-size: 14px; font-weight: 500; transition: all 0.15s;"
                        onmouseover="if(!this.disabled) this.style.borderColor='#3b82f6'; if(!this.disabled) this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                        onmouseout="if(!this.disabled) this.style.borderColor='#e5e5e5'; if(!this.disabled) this.style.boxShadow='none';"
                        ${isIn ? 'disabled' : ''}>
                        ${isIn ? '<span style="color: #10b981; margin-right: 6px;">âœ“</span>' : ''}${collectionName}
                    </button>`;
        });
        container.innerHTML = buttons;
    }
        });
}

    function addToCollection(collectionId, highlightId) {
        fetch(`/collections/${collectionId}/highlights/${highlightId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(() => window.location.reload());
    }
</script>
{% endblock %}