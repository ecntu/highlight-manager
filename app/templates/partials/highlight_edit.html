<div id="highlight-view" class="card" style="padding: 20px 24px;">
    <form hx-patch="/highlights/{{ highlight.id }}" hx-target="#highlight-view" hx-swap="outerHTML">
        <div class="form-group">
            <label>Highlight Text</label>
            <textarea name="text" rows="6" required
                style="font-size: 15px; line-height: 1.6;">{{ highlight.text }}</textarea>
        </div>

        <div class="form-group">
            <label>Your Note</label>
            <textarea name="note" rows="3" placeholder="Why does this matter?"
                style="font-size: 14px;">{{ highlight.note or '' }}</textarea>
        </div>

        <div class="form-group">
            <label>Tags (comma-separated)</label>
            <input type="text" name="tags"
                value="{% if highlight.tags %}{% for tag in highlight.tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}"
                placeholder="productivity, inspiration, ideas">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
                <label>Source URL (for web)</label>
                <input type="text" name="source_url" value="{{ highlight.url or '' }}"
                    placeholder="https://example.com/article">
            </div>

            <div class="form-group">
                <label>Source Title (for books)</label>
                <input type="text" name="source_title"
                    value="{{ highlight.source.title if highlight.source and highlight.source.type.value == 'book' else '' }}"
                    placeholder="Book title">
            </div>
        </div>

        <div class="form-group">
            <label>Author</label>
            <input type="text" name="source_author"
                value="{{ highlight.page_author or (highlight.source.author if highlight.source else '') }}"
                placeholder="Author name">
        </div>

        <div class="form-actions" style="margin-top: 16px; gap: 10px;">
            <button type="submit" class="btn btn--ghost">Save</button>
            <button type="button" id="cancel-edit-{{ highlight.id }}" hx-get="/highlights/{{ highlight.id }}"
                hx-target="#highlight-view" hx-swap="outerHTML" class="btn btn--ghost btn--sm">Cancel</button>
        </div>
    </form>
</div>
<script>
    (function () {
        const cancelButton = document.getElementById('cancel-edit-{{ highlight.id }}');
        if (!cancelButton) return;
        const onKeyDown = (event) => {
            if (event.key === 'Escape') {
                event.preventDefault();
                cancelButton.click();
            }
        };
        document.addEventListener('keydown', onKeyDown, { once: true });
    })();
</script>
