{% extends "base.html" %}

{% block title %}Sources - PHM{% endblock %}

{% block content %}
<div>
    <div class="row-between" style="margin-bottom: 24px;">
        <h2 class="section-title" style="margin: 0;">Sources</h2>
    </div>

    <form id="sources-filter-form" method="get" action="/sources" class="card" style="margin-bottom: 16px; padding: 14px;">
        <div class="row" style="gap: 10px; flex-wrap: wrap;">
            <input type="text" name="q" value="{{ q }}" placeholder="Search name, domain, title, author"
                style="flex: 1 1 240px; min-width: 0; width: 100%;">
            <select name="type" class="select-compact" onchange="this.form.requestSubmit()">
                <option value="">All types</option>
                <option value="book" {% if source_type=='book' %}selected{% endif %}>Book</option>
                <option value="web" {% if source_type=='web' %}selected{% endif %}>Web</option>
            </select>
            <select name="sort" class="select-compact" onchange="this.form.requestSubmit()">
                <option value="recent-desc" {% if sort=='recent-desc' %}selected{% endif %}>Recent (Newest)</option>
                <option value="recent-asc" {% if sort=='recent-asc' %}selected{% endif %}>Recent (Oldest)</option>
                <option value="highlights-desc" {% if sort=='highlights-desc' %}selected{% endif %}>Highlights (High to Low)</option>
                <option value="highlights-asc" {% if sort=='highlights-asc' %}selected{% endif %}>Highlights (Low to High)</option>
                <option value="favorites-desc" {% if sort=='favorites-desc' %}selected{% endif %}>Favorites (High to Low)</option>
                <option value="favorites-asc" {% if sort=='favorites-asc' %}selected{% endif %}>Favorites (Low to High)</option>
                <option value="name-asc" {% if sort=='name-asc' %}selected{% endif %}>Name (A to Z)</option>
                <option value="name-desc" {% if sort=='name-desc' %}selected{% endif %}>Name (Z to A)</option>
            </select>
            <a href="/sources" class="btn btn--ghost btn--sm" style="text-decoration: none;">Reset</a>
        </div>
    </form>

    {% if sources %}
    <div class="stack">
        {% for source in sources %}
        <div class="list-card clickable" onclick="window.location='/sources/{{ source.id }}'">
            <div class="row-between" style="align-items: start;">
                <div style="flex: 1; min-width: 0;">
                    <h3 style="font-size: 15px; margin-bottom: 6px; font-weight: 600;">{{ source.source_name }}</h3>
                    {% if source.author %}
                    <p class="muted" style="font-size: 13px; margin-bottom: 8px;">{{ source.author }}</p>
                    {% endif %}
                    <div class="row" style="gap: 12px; font-size: 13px;">
                        <span class="muted-2" style="text-transform: capitalize;">{{ source.type.value }}</span>
                        <span class="meta-divider">·</span>
                        <span class="muted-2">{{ source.highlight_count }} highlight{% if source.highlight_count != 1 %}s{% endif %}</span>
                        {% if source.favorite_highlight_count > 0 %}
                        <span class="meta-divider">·</span>
                        <span class="muted">♥ {{ source.favorite_highlight_count }}</span>
                        {% endif %}
                        {% if source.last_highlight_at %}
                        <span class="meta-divider">·</span>
                        <span class="muted-2">{{ source.last_highlight_at.strftime('%b %d, %Y') }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="muted-2" style="text-align: center; padding: 40px 0;">No sources yet. Add highlights with source
        information to see them here.</p>
    {% endif %}
</div>
<script>
    (function () {
        const form = document.getElementById('sources-filter-form');
        if (!form) return;
        const searchInput = form.querySelector('input[name="q"]');
        if (!searchInput) return;
        let timerId = null;
        searchInput.addEventListener('input', function () {
            if (timerId) clearTimeout(timerId);
            timerId = setTimeout(function () {
                form.requestSubmit();
            }, 300);
        });
    })();
</script>
{% endblock %}
